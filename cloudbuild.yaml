steps:
- id: 'enable services'
  name: 'gcr.io/cloud-builders/gcloud'
  entrypoint: 'bash'
  args:
    - '-c'
    - |-
        gcloud services enable serviceusage.googleapis.com
        gcloud services enable compute.googleapis.com
        gcloud services enable container.googleapis.com
        gcloud services enable cloudresourcemanager.googleapis.com
        gcloud services enable cloudbuild.googleapis.com
        gcloud services enable artifactregistry.googleapis.com

- id: 'tf init'
  name: 'hashicorp/terraform:latest'
  entrypoint: 'sh'
  args: 
  - '-c'
  - |-
      cd terraform
      terraform init --backend-config="bucket=$REPO_NAME-$PROJECT_ID-tfstate"

# [START tf-plan]
- id: 'tf plan'
  name: 'hashicorp/terraform:latest'
  entrypoint: 'sh'
  args: 
  - '-c'
  - |-
      cd terraform
      terraform plan -var="project_id=$PROJECT_ID" -var="service_account_email=$PROJECT_NUMBER-compute@developer.gserviceaccount.com"
# [END tf-plan]

# [START tf-apply]
- id: 'tf apply'
  name: 'hashicorp/terraform:latest'
  entrypoint: 'sh'
  args: 
  - '-c'
  - |- 
      cd terraform
      terraform apply -auto-approve -var="project_id=$PROJECT_ID" -var="service_account_email=$PROJECT_NUMBER-compute@developer.gserviceaccount.com"
# [END tf-apply]      
#Build
- name: 'gcr.io/cloud-builders/docker'
  args:
    - 'build'
    - '-t'
    - '$LOCATION-docker.pkg.dev/$PROJECT_ID/$REPO_NAME/$REPO_NAME-image:${BUILD_ID}'
    - '-t'
    - '$LOCATION-docker.pkg.dev/$PROJECT_ID/$REPO_NAME/$REPO_NAME-image:latest'
    - '.'
#Push image
- name: 'gcr.io/cloud-builders/docker'
  args:
    - 'push'
    - '$LOCATION-docker.pkg.dev/$PROJECT_ID/$REPO_NAME/$REPO_NAME-image'
    - '--all-tags'
#Deploy to GKE
- name: "gcr.io/cloud-builders/gke-deploy"
  args:
  - run
  - --filename=kuberetes/deployment.yaml
  - --image=$LOCATION-docker.pkg.dev/$PROJECT_ID/$REPO_NAME/$REPO_NAME-image:latest
  - --location=$LOCATION
  - --cluster=mms-cluster-gke